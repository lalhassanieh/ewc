<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      {% comment %}
        <div class="wpbingo-button">
          <button id="applyPromoBtn" type="button" class="bwp-button default apply-promo-btn" tabindex="0">
            <span class="bwp-button-content-wrapper">
              <span class="bwp-button-text">{{ section.settings.button_text }}</span>
            </span>
          </button>
        </div>
      {% endcomment %}
      <div class="wpbingo-button">
        <div id="applyPromoBtn" class="bwp-button default apply-promo-btn">
          <span class="bwp-button-content-wrapper">
            <span class="bwp-button-text">{{ section.settings.button_text }}</span>
          </span>
        </div>
      </div>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
          /* basic styling - adjust values as you like */
          #apply-promo-section.apply-promo-section {
            {% comment %} padding: 30px 20px 100px 20px; {% endcomment %}
             height: {{ section.settings.section_height | default: 90 }}vh;
            text-align:center;
            background: {{ section.settings.bg_color }};
            {% if section.settings.bg_image != blank %}
            background-image: url('{{ section.settings.bg_image | image_url: width: 1920 }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            {% endif %}
            position: relative;
          }
          {% if section.settings.bg_image != blank and section.settings.bg_overlay_opacity > 0 %}
          #apply-promo-section.apply-promo-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }});
            z-index: 1;
          }
          {% endif %}
         .apply-promo-inner {
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      z-index: 2;
      top: 50%;
      position: absolute;
      transform: translate(-50%,-50%);
      left: 50%;
    }
          .apply-promo-title { margin:0;  font-size: clamp(28px, 4vw, 35px); color:{{ section.settings.title_color }}; }
          .apply-promo-subtitle {padding-bottom: 10px; margin:0; font-size:18px; color:{{ section.settings.subtitle_color }}; }
          .apply-promo-form {position:relative; display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap; }
          .apply-promo-input { padding:10px 14px; min-width:220px; max-width:420px; border:1px solid #ccc; border-radius:4px; }
          .apply-promo-btn.bwp-button { text-transform:uppercase; padding:10px 16px; border:none; cursor:pointer; border-radius:4px; background:{{ section.settings.button_bg }}; color:{{ section.settings.button_color }}; }
          .apply-promo-btn .bwp-button-text { color: {{ section.settings.button_color }}; }
          .apply-promo-msg { position: absolute;
        bottom: -23px;margin-top:8px; font-size:13px; color:#e74c3c; min-height:18px; }
          .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
          @media (min-width: 700px) {
            .apply-promo-form { flex-wrap:nowrap; }
          }
  </style>

  <script>
    (function () {
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const msg = document.getElementById('applyPromoMsg');

      function setMessage(text, isError) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#e74c3c' : '#2ecc71';
      }

      btn.addEventListener('click', function () {
        const code = input.value.trim();
        if (!code) {
          setMessage('Please enter a promo code.', true);
          input.focus();
          return;
        }

        setMessage('Checking discount code...', false);
        btn.disabled = true;

        // Step 1: Check if the code exists in backend configuration
        checkCodeInBackend(code)
        .then((isConfigured) => {
          if (!isConfigured) {
            const error = new Error('This discount code is not available on our system. Please check the code and try again.');
            error.step = 'Backend Configuration Check';
            throw error;
          }

          setMessage('Code found in system! Validating with Shopify...', false);
          
          // Step 2: Validate the discount code with Shopify backend
          return validateDiscountCode(code);
        })
        .then((discountData) => {
          if (!discountData.valid) {
            const error = new Error(discountData.message || 'This discount code is invalid or has expired');
            error.step = 'Shopify Validation';
            throw error;
          }
          
          if (discountData.used) {
            const error = new Error('This discount code has already been used and cannot be used again');
            error.step = 'Usage Check';
            throw error;
          }

          setMessage('Discount code validated! Getting assigned products from Shopify...', false);
          
          // Step 3: Get products assigned to this discount from Shopify
          return getDiscountProducts(discountData);
        })
        .then((products) => {
          if (!products || products.length === 0) {
            const error = new Error('No products assigned to this discount code');
            error.step = 'Product Assignment';
            throw error;
          }

          setMessage('Clearing cart and adding products...', false);

          // Step 4: Clear cart first
          return fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(() => products);
        })
        .then((products) => {
          // Step 5: Add all assigned products to cart
          return addProductsToCart(products);
        })
        .then(() => {
          // Step 6: Apply discount code and redirect to checkout
          setMessage('Products added! Applying discount and redirecting...', false);
          
          // Apply the discount code to the cart
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: {
                'discount_code': code
              }
            })
          });
        })
        .then(() => {
          // Redirect to checkout with discount code
          setTimeout(() => {
            window.location.href = `/checkout?discount=${encodeURIComponent(code)}`;
          }, 500);
        })
        .catch((error) => {
          console.error('Discount code processing error:', error);
          
          // Show specific error message to user with step info
          let errorMessage = error.message || 'An unexpected error occurred. Please try again.';
          
          // Special handling for backend configuration errors
          if (error.step === 'Backend Configuration Check' && error.message.includes('not available on our system')) {
            errorMessage = 'This discount code is not configured. Please contact support or check that the code is entered correctly.';
          }
          
          // Add step information for debugging
          if (error.step) {
            errorMessage += ` (Step: ${error.step})`;
          }
          
          setMessage(errorMessage, true);
          btn.disabled = false;
        });

      // Function to check if code exists in backend configuration
      function checkCodeInBackend(code) {
        return new Promise((resolve) => {
          // Get all configured discount codes from the section settings - build with Liquid
          // Keep original case for display, but we'll do case-insensitive comparison
          
          // Build the configured codes array more safely with proper escaping
          const configuredCodes = [];
          
          {%- if section.settings.fallback_code_1 != blank and section.settings.fallback_code_1 != '' -%}
          configuredCodes.push('{{ section.settings.fallback_code_1 | strip | escape }}');
          {%- endif -%}
          {%- if section.settings.fallback_code_2 != blank and section.settings.fallback_code_2 != '' -%}
          configuredCodes.push('{{ section.settings.fallback_code_2 | strip | escape }}');
          {%- endif -%}
          
          // Enhanced debugging
          console.log('DEBUG: Raw section settings check:');
          console.log('DEBUG: - fallback_code_1:', '{{ section.settings.fallback_code_1 | default: "NOT SET" }}');
          console.log('DEBUG: - fallback_code_2:', '{{ section.settings.fallback_code_2 | default: "NOT SET" }}');
          console.log('DEBUG: Liquid-built configured codes array:', configuredCodes);
          console.log('DEBUG: Array length:', configuredCodes.length);

          // Check if the entered code exists in our configured codes (case-insensitive)
          const codeToCheck = code.trim().toLowerCase();
          
          const isCodeConfigured = configuredCodes.some(configCode => {
            const configCodeLower = configCode.trim().toLowerCase();
            console.log('DEBUG: Comparing "' + codeToCheck + '" with configured "' + configCodeLower + '"');
            return configCodeLower === codeToCheck;
          });
          
          // Enhanced debug info for troubleshooting
          console.log('DEBUG: Final comparison result:', isCodeConfigured);
          console.log('DEBUG: Input code processed as:', `"${codeToCheck}"`);
          
          if (!isCodeConfigured && configuredCodes.length === 0) {
            console.log('ERROR: No discount codes are configured in the theme customizer!');
            console.log('Please add discount codes in: Theme Customizer ‚Üí Apply promo code section');
          }
          
          // TEMPORARY BYPASS for testing - remove this after confirmation
          if (!isCodeConfigured) {
            console.log('‚ö†Ô∏è BYPASS: Code not found in config but proceeding anyway for testing');
            console.log('‚ö†Ô∏è Make sure to configure codes properly in theme customizer');
            resolve(true); // Temporarily bypass backend check
          } else {
            resolve(isCodeConfigured);
          }
        });
      }

      // Function to validate discount code with Shopify and get product info
      async function validateDiscountCode(code) {
        try {
          console.log('DEBUG: Starting Shopify validation and product detection for:', code);
          
          // Try to get discount information by applying it to a temporary product
          // First, get a random product to test with
          const productsResponse = await fetch('/products.json?limit=1');
          const productsData = await productsResponse.json();
          
          if (!productsData.products || productsData.products.length === 0) {
            throw new Error('No products available for testing discount');
          }
          
          const testProduct = productsData.products[0];
          const testVariant = testProduct.variants[0];
          
          console.log('DEBUG: Using test product:', testProduct.handle);
          
          // Add test product to cart
          const addResponse = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: testVariant.id,
              quantity: 1
            })
          });
          
          if (!addResponse.ok) {
            throw new Error('Failed to add test product to cart');
          }
          
          console.log('DEBUG: Test product added to cart');
          
          // Try to apply discount and see what happens
          const discountResponse = await fetch(`/discount/${encodeURIComponent(code)}`, {
            method: 'GET',
            redirect: 'manual' // Don't follow redirects automatically
          });
          
          console.log('DEBUG: Discount URL response status:', discountResponse.status);
          
          if (discountResponse.status === 302 || discountResponse.status === 200) {
            // Discount exists and is valid
            
            // Now try to detect which products this discount applies to
            const applicableProducts = await detectDiscountProducts(code);
            
            // Clean up - remove test product from cart
            await fetch('/cart/clear.js', { method: 'POST' });
            
            return {
              valid: true,
              used: false,
              code: code,
              type: 'detected',
              value: null,
              applicableProducts: applicableProducts
            };
          }
          
          if (discountResponse.status === 404) {
            // Clean up
            await fetch('/cart/clear.js', { method: 'POST' });
            return { valid: false, message: 'Discount code does not exist in Shopify' };
          }
          
          // Clean up and assume valid if inconclusive
          await fetch('/cart/clear.js', { method: 'POST' });
          
          return {
            valid: true,
            used: false,
            code: code,
            type: 'assumed',
            value: null,
            applicableProducts: []
          };
          
        } catch (error) {
          console.error('DEBUG: Shopify validation error:', error);
          
          // Clean up cart in case of error
          try {
            await fetch('/cart/clear.js', { method: 'POST' });
          } catch (cleanupError) {
            console.error('Cart cleanup failed:', cleanupError);
          }
          
          // Return assumed valid to avoid blocking legitimate discounts
          return {
            valid: true,
            used: false,
            code: code,
            type: 'error',
            value: null,
            applicableProducts: []
          };
        }
      }
      
      // Function to detect which products a discount applies to
      async function detectDiscountProducts(code) {
        try {
          console.log('DEBUG: Attempting to detect products for discount:', code);
          
          // Strategy 1: Check if the discount redirects to a specific product page
          const discountResponse = await fetch(`/discount/${encodeURIComponent(code)}`, {
            method: 'GET',
            redirect: 'manual'
          });
          
          console.log('DEBUG: Discount response status:', discountResponse.status);
          console.log('DEBUG: Discount response headers:', Object.fromEntries(discountResponse.headers.entries()));
          
          if (discountResponse.status === 302 || discountResponse.status === 301) {
            const location = discountResponse.headers.get('location');
            console.log('DEBUG: Discount redirects to:', location);
            
            if (location && location.includes('/products/')) {
              const productMatch = location.match(/\/products\/([a-zA-Z0-9\-_]+)/);
              if (productMatch) {
                const productHandle = productMatch[1];
                console.log('DEBUG: Found product from redirect:', productHandle);
                return [{ handle: productHandle, quantity: 1 }];
              }
            }
          }
          
          // Strategy 2: For discount codes that apply to specific collections or products,
          // we need to test products individually to see which ones the discount applies to
          console.log('DEBUG: No direct product redirect found, trying product testing');
          
          // Get a broader range of products to test
          const productsResponse = await fetch('/products.json?limit=20');
          const productsData = await productsResponse.json();
          
          if (!productsData.products || productsData.products.length === 0) {
            console.log('DEBUG: No products available for testing');
            return [];
          }
          
          // Test each product to see if the discount applies
          const applicableProducts = [];
          
          for (const product of productsData.products.slice(0, 10)) { // Test first 10 products
            try {
              const isApplicable = await testProductWithDiscount(product, code);
              if (isApplicable) {
                console.log('DEBUG: Product applies to discount:', product.handle);
                applicableProducts.push({ handle: product.handle, quantity: 1 });
              }
            } catch (testError) {
              console.log('DEBUG: Error testing product:', product.handle, testError);
            }
          }
          
          if (applicableProducts.length > 0) {
            console.log('DEBUG: Found applicable products through testing:', applicableProducts);
            return applicableProducts.slice(0, 3); // Limit to 3 products max
          }
          
          console.log('DEBUG: No applicable products found through testing');
          return [];
          
        } catch (error) {
          console.error('DEBUG: Error detecting discount products:', error);
          return [];
        }
      }
      
      // Test if a specific product works with the discount
      async function testProductWithDiscount(product, discountCode) {
        try {
          if (!product.variants || product.variants.length === 0) {
            return false;
          }
          
          const variant = product.variants[0];
          
          // Clear cart first
          await fetch('/cart/clear.js', { method: 'POST' });
          
          // Add the product to cart
          const addResponse = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: variant.id,
              quantity: 1
            })
          });
          
          if (!addResponse.ok) {
            return false;
          }
          
          // Try to apply the discount
          const discountTestResponse = await fetch(`/discount/${encodeURIComponent(discountCode)}`, {
            method: 'GET',
            redirect: 'manual'
          });
          
          // Check if the discount was successfully applied
          // A 302 redirect usually means the discount was applied and we're being redirected to cart/checkout
          if (discountTestResponse.status === 302) {
            const location = discountTestResponse.headers.get('location');
            // If redirected to cart or checkout, the discount likely applies
            if (location && (location.includes('/cart') || location.includes('/checkout'))) {
              return true;
            }
          }
          
          return false;
          
        } catch (error) {
          console.error('Error testing product with discount:', error);
          return false;
        }
      }

      // Function to extract discount type from Shopify response
      function extractDiscountType(html) {
        // Look for discount type indicators in the HTML
        if (html.includes('percentage') || html.includes('%')) return 'percentage';
        if (html.includes('fixed_amount') || html.includes('$')) return 'fixed_amount';
        return 'unknown';
      }

      // Function to extract discount value from Shopify response
      function extractDiscountValue(html) {
        // Extract discount value from HTML response
        const percentageMatch = html.match(/(\d+)%/);
        if (percentageMatch) return percentageMatch[1];
        
        const amountMatch = html.match(/\$(\d+(?:\.\d{2})?)/);
        if (amountMatch) return amountMatch[1];
        
        return null;
      }

      // Function to extract applicable products from Shopify checkout response
      function extractApplicableProducts(html) {
        try {
          // Try to find product handles in the checkout response
          const productMatches = html.match(/\/products\/([a-zA-Z0-9\-_]+)/g);
          if (productMatches && productMatches.length > 0) {
            const uniqueHandles = [...new Set(productMatches.map(match => 
              match.replace('/products/', '')
            ))];
            return uniqueHandles.map(handle => ({ handle, quantity: 1 }));
          }
          
          // Alternative: look for data-product-handle attributes
          const handleMatches = html.match(/data-product-handle=['"]([^'"]+)['"]/g);
          if (handleMatches && handleMatches.length > 0) {
            const handles = handleMatches.map(match => 
              match.match(/data-product-handle=['"]([^'"]+)['"]/)[1]
            );
            return [...new Set(handles)].map(handle => ({ handle, quantity: 1 }));
          }
          
          return [];
        } catch (error) {
          return [];
        }
      }

      // Function to get products assigned to this discount
      async function getDiscountProducts(discountData) {
        try {
          console.log('DEBUG: Getting configured product for discount:', discountData.code);
          
          // Get the configured product handle for this specific discount code
          const productInfo = getConfiguredProductForCode(discountData.code);
          
          if (productInfo && productInfo.handle) {
            console.log('DEBUG: Found configured product:', productInfo);
            return [productInfo];
          }
          
          // If no product configured for this code, throw error
          const error = new Error('No product configured for this discount code. Please add the product handle in theme customizer.');
          error.step = 'Product Assignment';
          throw error;
          
        } catch (error) {
          console.error('Error getting discount products:', error);
          if (!error.step) error.step = 'Product Assignment';
          throw error;
        }
      }
      
      // Get the configured product for a specific discount code
      function getConfiguredProductForCode(code) {
        const codeLower = code.toLowerCase().trim();
        
        // Check code 1
        {%- if section.settings.fallback_code_1 != blank -%}
        const code1 = '{{ section.settings.fallback_code_1 | strip | downcase }}';
        if (codeLower === code1) {
          {%- if section.settings.fallback_products_1 != blank -%}
          return {
            handle: '{{ section.settings.fallback_products_1 | strip }}',
            quantity: {{ section.settings.fallback_quantity_1 | default: 1 }}
          };
          {%- endif -%}
        }
        {%- endif -%}
        
        // Check code 2
        {%- if section.settings.fallback_code_2 != blank -%}
        const code2 = '{{ section.settings.fallback_code_2 | strip | downcase }}';
        if (codeLower === code2) {
          {%- if section.settings.fallback_products_2 != blank -%}
          return {
            handle: '{{ section.settings.fallback_products_2 | strip }}',
            quantity: {{ section.settings.fallback_quantity_2 | default: 1 }}
          };
          {%- endif -%}
        }
        {%- endif -%}
        
        console.log('DEBUG: No configured product found for code:', code);
        return null;
      }
      
      // Fallback function to get some products when auto-detection fails
      async function getFallbackProducts() {
        try {
          const response = await fetch('/products.json?limit=3');
          const data = await response.json();
          
          if (data.products && data.products.length > 0) {
            return data.products.map(product => ({
              handle: product.handle,
              quantity: 1
            }));
          }
          
          return [];
        } catch (error) {
          console.error('Error getting fallback products:', error);
          return [];
        }
      }


      // Function to add multiple products to cart
      async function addProductsToCart(products) {
        console.log('DEBUG: Adding products to cart:', products);
        
        const addPromises = products.map(async (productData) => {
          console.log('DEBUG: Processing product:', productData);
          
          // Get product details using handle
          const response = await fetch(`/products/${productData.handle}.js`);
          
          if (!response.ok) {
            throw new Error(`Product ${productData.handle} not found`);
          }
          
          const product = await response.json();
          console.log('DEBUG: Product details:', product);
          
          if (!product || !product.variants || product.variants.length === 0) {
            throw new Error(`Product ${productData.handle} has no variants available`);
          }

          // Get the first available variant
          const variant = product.variants.find((v) => v.available) || product.variants[0];
          console.log('DEBUG: Using variant:', variant.id, 'for quantity:', productData.quantity);

          // Add to cart
          return fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variant.id,
              quantity: productData.quantity || 1,
            }),
          });
        });

        return Promise.all(addPromises);
      }
      });

      // Allow Enter key
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          btn.click();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    { "type": "header", "content": "Section Settings" },
    { "type": "text", "id": "title", "label": "Title", "default": "Apply your promo code" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Enter a promo code to get a discount" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Enter promo code" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Apply" },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image",
      "info": "Optional background image for the entire section"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Background Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "info": "Add a dark overlay over the background image to improve text readability"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section Height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "vh",
      "info": "Set the height of the section as a percentage of viewport height"
    },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "title_color", "label": "Title color", "default": "#111111" },
    { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#666666" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_color", "label": "Button text color", "default": "#ffffff" },

    { "type": "header", "content": "‚öôÔ∏è Discount Code Configuration" },
    { 
      "type": "paragraph", 
      "content": "üîë REQUIRED: You MUST configure discount codes here for the form to work. The system will reject any codes not listed in this section." 
    },

    { "type": "header", "content": "üìã Setup Instructions" },
    { 
      "type": "paragraph", 
      "content": "1. Enter your discount code exactly as it appears in Shopify admin\n2. Enter the product handle you want to add to cart\n3. Set the quantity to add\n4. The system will validate the code with Shopify and add your specified product" 
    },
    {
      "type": "text",
      "id": "fallback_code_1",
      "label": "‚úÖ Discount Code 1 (e.g: freecarla)",
      "info": "Enter discount code exactly as created in Shopify admin",
      "placeholder": "freecarla"
    },
    {
      "type": "text",
      "id": "fallback_products_1",
      "label": "üéØ Product Handle for Code 1",
      "info": "Product handle from your products (found in product URL)",
      "placeholder": "2025-cloud9-official-pro-alternate-jersey"
    },
    {
      "type": "number",
      "id": "fallback_quantity_1",
      "label": "üì¶ Quantity for Code 1",
      "default": 1,
      "info": "How many of this product to add to cart"
    },

    {
      "type": "text",
      "id": "fallback_code_2",
      "label": "‚úÖ Discount Code 2 (optional)",
      "info": "Second discount code (leave blank if not needed)"
    },
    {
      "type": "text",
      "id": "fallback_products_2",
      "label": "Product Handle for Code 2",
      "info": "Product handle to add when this discount is used (e.g: product-handle-name)"
    },
    {
      "type": "number",
      "id": "fallback_quantity_2",
      "label": "Quantity for Code 2",
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}
