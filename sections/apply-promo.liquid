<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      {% comment %}
        <div class="wpbingo-button">
          <button id="applyPromoBtn" type="button" class="bwp-button default apply-promo-btn" tabindex="0">
            <span class="bwp-button-content-wrapper">
              <span class="bwp-button-text">{{ section.settings.button_text }}</span>
            </span>
          </button>
        </div>
      {% endcomment %}
      <div class="wpbingo-button">
        <div id="applyPromoBtn" class="bwp-button default apply-promo-btn">
          <span class="bwp-button-content-wrapper">
            <span class="bwp-button-text">{{ section.settings.button_text }}</span>
          </span>
        </div>
      </div>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
          /* basic styling - adjust values as you like */
          #apply-promo-section.apply-promo-section {
            {% comment %} padding: 30px 20px 100px 20px; {% endcomment %}
             height: {{ section.settings.section_height | default: 90 }}vh;
            text-align:center;
            background: {{ section.settings.bg_color }};
            {% if section.settings.bg_image != blank %}
            background-image: url('{{ section.settings.bg_image | image_url: width: 1920 }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            {% endif %}
            position: relative;
          }
          {% if section.settings.bg_image != blank and section.settings.bg_overlay_opacity > 0 %}
          #apply-promo-section.apply-promo-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }});
            z-index: 1;
          }
          {% endif %}
         .apply-promo-inner {
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      z-index: 2;
      top: 50%;
      position: absolute;
      transform: translate(-50%,-50%);
      left: 50%;
    }
          .apply-promo-title { margin:0;  font-size: clamp(28px, 4vw, 35px); color:{{ section.settings.title_color }}; }
          .apply-promo-subtitle {padding-bottom: 10px; margin:0; font-size:18px; color:{{ section.settings.subtitle_color }}; }
          .apply-promo-form {position:relative; display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap; }
          .apply-promo-input { padding:10px 14px; min-width:220px; max-width:420px; border:1px solid #ccc; border-radius:4px; }
          .apply-promo-btn.bwp-button { text-transform:uppercase; padding:10px 16px; border:none; cursor:pointer; border-radius:4px; background:{{ section.settings.button_bg }}; color:{{ section.settings.button_color }}; }
          .apply-promo-btn .bwp-button-text { color: {{ section.settings.button_color }}; }
          .apply-promo-msg { position: absolute;
        bottom: -23px;margin-top:8px; font-size:13px; color:#e74c3c; min-height:18px; }
          .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
          @media (min-width: 700px) {
            .apply-promo-form { flex-wrap:nowrap; }
          }
  </style>

  <script>
    (function () {
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const msg = document.getElementById('applyPromoMsg');

      function setMessage(text, isError) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#e74c3c' : '#2ecc71';
      }

      btn.addEventListener('click', function () {
        const code = input.value.trim();
        if (!code) {
          setMessage('Please enter a promo code.', true);
          input.focus();
          return;
        }

        setMessage('Checking discount code...', false);
        btn.disabled = true;

        // Step 1: Check if the code exists in backend configuration
        checkCodeInBackend(code)
        .then((isConfigured) => {
          if (!isConfigured) {
            const error = new Error('This discount code is not available on our system. Please check the code and try again.');
            error.step = 'Backend Configuration Check';
            throw error;
          }

          setMessage('Code found in system! Validating with Shopify...', false);
          
          // Step 2: Validate the discount code with Shopify backend
          return validateDiscountCode(code);
        })
        .then((discountData) => {
          if (!discountData.valid) {
            const error = new Error(discountData.message || 'This discount code is invalid or has expired');
            error.step = 'Shopify Validation';
            throw error;
          }
          
          if (discountData.used) {
            const error = new Error('This discount code has already been used and cannot be used again');
            error.step = 'Usage Check';
            throw error;
          }

          setMessage('Discount code validated! Getting assigned products from Shopify...', false);
          
          // Step 3: Get products assigned to this discount from Shopify
          return getDiscountProducts(discountData);
        })
        .then((products) => {
          if (!products || products.length === 0) {
            const error = new Error('No products assigned to this discount code');
            error.step = 'Product Assignment';
            throw error;
          }

          setMessage('Clearing cart and adding products...', false);

          // Step 4: Clear cart first
          return fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(() => products);
        })
        .then((products) => {
          // Step 5: Add all assigned products to cart
          return addProductsToCart(products);
        })
        .then(() => {
          // Step 6: Apply discount code and redirect to checkout
          setMessage('Products added! Applying discount and redirecting...', false);
          
          // Apply the discount code to the cart
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: {
                'discount_code': code
              }
            })
          });
        })
        .then(() => {
          // Redirect to checkout with discount code
          setTimeout(() => {
            window.location.href = `/checkout?discount=${encodeURIComponent(code)}`;
          }, 500);
        })
        .catch((error) => {
          console.error('Discount code processing error:', error);
          
          // Show specific error message to user with step info
          let errorMessage = error.message || 'An unexpected error occurred. Please try again.';
          
          // Add step information for debugging
          if (error.step) {
            errorMessage += ` (Step: ${error.step})`;
          }
          
          setMessage(errorMessage, true);
          btn.disabled = false;
        });

      // Function to check if code exists in backend configuration
      function checkCodeInBackend(code) {
        return new Promise((resolve) => {
          // Get all configured discount codes from the section settings
          const configuredCodes = [];
          
          // Add fallback codes if configured (with trimming and case handling)
          {%- if section.settings.fallback_code_1 != blank -%}
          configuredCodes.push('{{ section.settings.fallback_code_1 | strip }}');
          {%- endif -%}
          {%- if section.settings.fallback_code_2 != blank -%}
          configuredCodes.push('{{ section.settings.fallback_code_2 | strip }}');
          {%- endif -%}

          // Check if the entered code exists in our configured codes (case-insensitive)
          const codeToCheck = code.trim().toLowerCase();
          const configuredCodesLower = configuredCodes.map(c => c.trim().toLowerCase());
          
          const isCodeConfigured = configuredCodesLower.includes(codeToCheck);
          
          // Temporary debug info for troubleshooting
          console.log('DEBUG: Configured codes:', configuredCodes);
          console.log('DEBUG: Code to check:', `"${code}"` + ' -> ' + `"${codeToCheck}"`);
          console.log('DEBUG: Match found:', isCodeConfigured);
          
          resolve(isCodeConfigured);
        });
      }

      // Function to validate discount code with Shopify
      async function validateDiscountCode(code) {
        try {
          // Create a temporary cart to test the discount
          const response = await fetch('/cart.js', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const cart = await response.json();
          
          // Try to apply discount to see if it exists and is valid
          const discountResponse = await fetch('/checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `discount=${encodeURIComponent(code)}&_method=GET`
          });

          if (discountResponse.ok) {
            // Check if discount was applied by examining response
            const text = await discountResponse.text();
            
            // Look for various discount error patterns in the HTML response
            if (text.includes('discount-code-error') || text.includes('discount_code_error') || 
                text.includes('invalid') || text.includes('expired') || text.includes('not found')) {
              return { valid: false, message: 'Discount code is invalid, expired, or not found' };
            }
            
            // Look for usage limit patterns
            if (text.includes('discount-already-used') || text.includes('usage_limit_reached') || 
                text.includes('already been used') || text.includes('limit exceeded') ||
                text.includes('maximum usage') || text.includes('no longer available')) {
              return { valid: true, used: true, message: 'Discount code has reached its usage limit' };
            }

            // Look for customer eligibility issues
            if (text.includes('not eligible') || text.includes('customer eligibility') || 
                text.includes('restricted') || text.includes('not applicable')) {
              return { valid: false, message: 'This discount code is not applicable to your account' };
            }

            // If we get here, discount is likely valid and unused
            return { 
              valid: true, 
              used: false, 
              code: code,
              // Extract discount info from response if needed
              type: extractDiscountType(text),
              value: extractDiscountValue(text),
              // Try to extract applicable products from the response
              applicableProducts: extractApplicableProducts(text)
            };
          } else {
            return { valid: false, message: 'Unable to validate discount code with Shopify' };
          }
        } catch (error) {
          console.error('Discount validation error:', error);
          return { valid: false, message: 'Error validating discount code' };
        }
      }

      // Function to extract discount type from Shopify response
      function extractDiscountType(html) {
        // Look for discount type indicators in the HTML
        if (html.includes('percentage') || html.includes('%')) return 'percentage';
        if (html.includes('fixed_amount') || html.includes('$')) return 'fixed_amount';
        return 'unknown';
      }

      // Function to extract discount value from Shopify response
      function extractDiscountValue(html) {
        // Extract discount value from HTML response
        const percentageMatch = html.match(/(\d+)%/);
        if (percentageMatch) return percentageMatch[1];
        
        const amountMatch = html.match(/\$(\d+(?:\.\d{2})?)/);
        if (amountMatch) return amountMatch[1];
        
        return null;
      }

      // Function to extract applicable products from Shopify checkout response
      function extractApplicableProducts(html) {
        try {
          // Try to find product handles in the checkout response
          const productMatches = html.match(/\/products\/([a-zA-Z0-9\-_]+)/g);
          if (productMatches && productMatches.length > 0) {
            const uniqueHandles = [...new Set(productMatches.map(match => 
              match.replace('/products/', '')
            ))];
            return uniqueHandles.map(handle => ({ handle, quantity: 1 }));
          }
          
          // Alternative: look for data-product-handle attributes
          const handleMatches = html.match(/data-product-handle=['"]([^'"]+)['"]/g);
          if (handleMatches && handleMatches.length > 0) {
            const handles = handleMatches.map(match => 
              match.match(/data-product-handle=['"]([^'"]+)['"]/)[1]
            );
            return [...new Set(handles)].map(handle => ({ handle, quantity: 1 }));
          }
          
          return [];
        } catch (error) {
          return [];
        }
      }

      // Function to get products assigned to this discount from Shopify
      async function getDiscountProducts(discountData) {
        try {
          // Priority 1: Products extracted from Shopify discount checkout response
          if (discountData.applicableProducts && discountData.applicableProducts.length > 0) {
            return discountData.applicableProducts.map(product => ({
              handle: product.handle,
              quantity: 1
            }));
          }
          
          // Priority 2: Manual configuration for specific discount codes
          const configuredProducts = await getConfiguredProducts(discountData.code);
          if (configuredProducts && configuredProducts.length > 0) {
            return configuredProducts;
          }
          
          // If no products found anywhere, throw an error
          throw new Error('No products assigned to this discount code');
          
        } catch (error) {
          console.error('Error getting discount products:', error);
          throw new Error('Unable to find products for this discount code');
        }
      }
      
      // Fallback function to get products from theme configuration
      async function getConfiguredProducts(code) {
        // This allows manual override for specific discount codes if needed
        const manualProductMap = {
          {%- if section.settings.fallback_code_1 != blank -%}
          '{{ section.settings.fallback_code_1 }}': [
            {%- if section.settings.fallback_products_1 != blank -%}
            ...{{ section.settings.fallback_products_1 | split: ',' | json }}.map(handle => ({ 
              handle: handle.trim(), 
              quantity: {{ section.settings.fallback_quantity_1 | default: 1 }} 
            }))
            {%- endif -%}
          ]{%- if section.settings.fallback_code_2 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.fallback_code_2 != blank -%}
          '{{ section.settings.fallback_code_2 }}': [
            {%- if section.settings.fallback_products_2 != blank -%}
            ...{{ section.settings.fallback_products_2 | split: ',' | json }}.map(handle => ({ 
              handle: handle.trim(), 
              quantity: {{ section.settings.fallback_quantity_2 | default: 1 }} 
            }))
            {%- endif -%}
          ]
          {%- endif -%}
        };
        
        const configuredProducts = manualProductMap[code];
        if (configuredProducts && configuredProducts.length > 0) {
          return configuredProducts;
        }
        
        // If no specific configuration, return a default product or throw error
        if ('{{ section.settings.default_product_handle }}') {
          return [{ 
            handle: '{{ section.settings.default_product_handle }}', 
            quantity: {{ section.settings.default_quantity | default: 1 }} 
          }];
        }
        
        throw new Error('No products configured for this discount code. Please contact support.');
      }

      // Function to add multiple products to cart
      async function addProductsToCart(products) {
        const addPromises = products.map(async (productData) => {
          // Get product details
          const response = await fetch(`/products/${productData.handle}.js`);
          const product = await response.json();
          
          if (!product || !product.variants || product.variants.length === 0) {
            throw new Error(`Product ${productData.handle} not found or no variants available`);
          }

          // Get the first available variant
          const variant = product.variants.find((v) => v.available) || product.variants[0];

          // Add to cart
          return fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variant.id,
              quantity: productData.quantity,
            }),
          });
        });

        return Promise.all(addPromises);
      }
      });

      // Allow Enter key
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          btn.click();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    { "type": "header", "content": "Section Settings" },
    { "type": "text", "id": "title", "label": "Title", "default": "Apply your promo code" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Enter a promo code to get a discount" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Enter promo code" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Apply" },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image",
      "info": "Optional background image for the entire section"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Background Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "info": "Add a dark overlay over the background image to improve text readability"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section Height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "vh",
      "info": "Set the height of the section as a percentage of viewport height"
    },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "title_color", "label": "Title color", "default": "#111111" },
    { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#666666" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_color", "label": "Button text color", "default": "#ffffff" },

    { "type": "header", "content": "Backend Discount Code Configuration" },
    { 
      "type": "paragraph", 
      "content": "IMPORTANT: Only discount codes entered in this section will be accepted by the form. System checks backend configuration first, then validates with Shopify, then automatically gets assigned products from Shopify discount settings." 
    },

    { "type": "header", "content": "Allowed Discount Codes" },
    { 
      "type": "paragraph", 
      "content": "Enter the discount codes you want to allow. Users can only use codes listed here. System will automatically detect products assigned to these discounts in Shopify admin." 
    },
    {
      "type": "text",
      "id": "fallback_code_1",
      "label": "Discount Code 1",
      "info": "First allowed discount code (must exist in Shopify admin)"
    },
    {
      "type": "text",
      "id": "fallback_products_1",
      "label": "Manual Products for Code 1 (Optional)",
      "info": "Only use if automatic detection fails. Comma-separated product handles (e.g: product-1,product-2)"
    },
    {
      "type": "number",
      "id": "fallback_quantity_1",
      "label": "Quantity per Product",
      "default": 1
    },

    {
      "type": "text",
      "id": "fallback_code_2",
      "label": "Discount Code 2",
      "info": "Second allowed discount code (must exist in Shopify admin)"
    },
    {
      "type": "text",
      "id": "fallback_products_2",
      "label": "Manual Products for Code 2 (Optional)", 
      "info": "Only use if automatic detection fails. Comma-separated product handles (e.g: product-1,product-2)"
    },
    {
      "type": "number",
      "id": "fallback_quantity_2",
      "label": "Quantity per Product",
      "default": 1
    },

    { "type": "header", "content": "Default Fallback (Optional)" },
    {
      "type": "text",
      "id": "default_product_handle",
      "label": "Default Product Handle", 
      "info": "Product to add if no products are detected for valid discount codes (optional last resort)"
    },
    {
      "type": "number",
      "id": "default_quantity",
      "label": "Default Quantity",
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}
