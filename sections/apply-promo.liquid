<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      <div class="wpbingo-button">
        <div id="applyPromoBtn" class="bwp-button default apply-promo-btn">
          <span class="bwp-button-content-wrapper">
            <span class="bwp-button-text">{{ section.settings.button_text }}</span>
          </span>
        </div>
      </div>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
    #apply-promo-section.apply-promo-section {
      height: {{ section.settings.section_height | default: 90 }}vh;
      text-align: center;
      background: {{ section.settings.bg_color }};
      {% if section.settings.bg_image != blank %}
      background-image: url('{{ section.settings.bg_image | image_url: width: 1920 }}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      {% endif %}
      position: relative;
    }
    
    {% if section.settings.bg_image != blank and section.settings.bg_overlay_opacity > 0 %}
    #apply-promo-section.apply-promo-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }});
      z-index: 1;
    }
    {% endif %}
    
    .apply-promo-inner {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      z-index: 2;
      top: 50%;
      position: absolute;
      transform: translate(-50%, -50%);
      left: 50%;
      padding: 0 20px;
    }
    
    .apply-promo-title { 
      margin: 0;  
      font-size: clamp(28px, 4vw, 35px); 
      color: {{ section.settings.title_color }}; 
    }
    
    .apply-promo-subtitle {
      padding-bottom: 10px; 
      margin: 0; 
      font-size: 18px; 
      color: {{ section.settings.subtitle_color }}; 
    }
    
    .apply-promo-form {
      position: relative; 
      display: flex; 
      gap: 10px; 
      width: 100%; 
      justify-content: center; 
      flex-wrap: wrap; 
    }
    
    .apply-promo-input { 
      padding: 10px 14px; 
      min-width: 220px; 
      max-width: 420px; 
      flex: 1;
      border: 1px solid #ccc; 
      border-radius: 4px; 
      text-transform: uppercase;
    }
    
    .apply-promo-btn.bwp-button { 
      text-transform: uppercase; 
      padding: 10px 16px; 
      border: none; 
      cursor: pointer; 
      border-radius: 4px; 
      background: {{ section.settings.button_bg }}; 
      color: {{ section.settings.button_color }};
      transition: opacity 0.3s;
    }
    
    .apply-promo-btn.bwp-button:hover {
      opacity: 0.9;
    }
    
    .apply-promo-btn.bwp-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .apply-promo-btn .bwp-button-text { 
      color: {{ section.settings.button_color }}; 
    }
    
    .apply-promo-msg { 
      position: absolute;
      bottom: -28px;
      left: 0;
      right: 0;
      margin-top: 8px; 
      font-size: 13px; 
      min-height: 18px;
      text-align: center;
    }
    
    .apply-promo-msg.error {
      color: #e74c3c;
    }
    
    .apply-promo-msg.success {
      color: #2ecc71;
    }
    
    .visually-hidden { 
      position: absolute !important; 
      height: 1px; 
      width: 1px; 
      overflow: hidden; 
      clip: rect(1px, 1px, 1px, 1px); 
      white-space: nowrap; 
    }
    
    @media (min-width: 700px) {
      .apply-promo-form { flex-wrap: nowrap; }
    }
  </style>

  <script>
    (function () {
      'use strict';
      
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const btnText = btn.querySelector('.bwp-button-text');
      const msg = document.getElementById('applyPromoMsg');

      // Clear input on page load
      input.value = '';
      
      // Build configuration from Liquid settings
      const PROMO_CONFIG = {
        {% for i in (1..8) %}
          {% assign code_key = 'fallback_code_' | append: i %}
          {% assign products_key = 'fallback_products_' | append: i %}
          {% if section.settings[code_key] != blank %}
            '{{ section.settings[code_key] | upcase | strip }}': {
              code: '{{ section.settings[code_key] | strip }}',
              products: '{{ section.settings[products_key] | strip }}'.split(',').map(h => h.trim()).filter(Boolean)
            }{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% endfor %}
      };
      
      console.log('Promo Configuration:', PROMO_CONFIG);
      
      // Helper: Show message
      function showMessage(text, isError) {
        msg.textContent = text || '';
        msg.className = 'apply-promo-msg ' + (isError ? 'error' : 'success');
      }
      
      // Helper: Set button loading state
      function setLoading(loading) {
        if (loading) {
          btn.classList.add('disabled');
          btnText.textContent = 'Processing...';
        } else {
          btn.classList.remove('disabled');
          btnText.textContent = '{{ section.settings.button_text }}';
        }
      }
      
      // Add products to cart (doesn't clear existing cart)
      async function addProductsToCart(productHandles) {
        if (!productHandles || productHandles.length === 0) {
          return { added: 0, skipped: 0 };
        }
        
        const items = [];
        let skipped = 0;
        
        // Fetch each product and prepare for batch add
        for (const handle of productHandles) {
          try {
            const response = await fetch(`/products/${handle}.js`);
            
            if (!response.ok) {
              console.warn(`Product ${handle} not found or not accessible`);
              skipped++;
              continue;
            }
            
            const product = await response.json();
            
            // Find first available variant
            const variant = product.variants.find(v => v.available) || product.variants[0];
            
            if (variant) {
              items.push({
                id: variant.id,
                quantity: 1
              });
            } else {
              skipped++;
            }
          } catch (error) {
            console.warn(`Error fetching product ${handle}:`, error);
            skipped++;
          }
        }
        
        // Batch add all items
        if (items.length > 0) {
          try {
            const response = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items })
            });
            
            if (response.ok) {
              return { added: items.length, skipped };
            }
          } catch (error) {
            console.error('Error adding items to cart:', error);
          }
        }
        
        return { added: 0, skipped: productHandles.length };
      }
      
      // Main click handler
      btn.addEventListener('click', async function () {
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
          showMessage('Please enter a promo code', true);
          input.focus();
          return;
        }
        
        // Check if code is configured
        if (!PROMO_CONFIG[code]) {
          showMessage('Invalid promo code. Please check and try again.', true);
          return;
        }
        
        setLoading(true);
        showMessage('Processing...', false);
        
        try {
          const config = PROMO_CONFIG[code];
          
          // Add products if configured
          if (config.products.length > 0) {
            showMessage('Adding products to cart...', false);
            const result = await addProductsToCart(config.products);
            
            if (result.added > 0) {
              showMessage(`Added ${result.added} item(s). Redirecting...`, false);
            } else if (result.skipped > 0) {
              showMessage('Some products unavailable. Applying discount...', false);
            }
          } else {
            showMessage('Applying discount...', false);
          }
          
          // Wait briefly for cart operations to complete
          await new Promise(resolve => setTimeout(resolve, 800));
          
          // Redirect to checkout with discount
          window.location.href = `/checkout?discount=${encodeURIComponent(config.code)}`;
          
        } catch (error) {
          console.error('Error:', error);
          showMessage('Something went wrong. Please try again.', true);
          setLoading(false);
        }
      });
      
      // Allow Enter key submission
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          btn.click();
        }
      });
      
      // Debug helper
      window.checkPromoConfig = () => {
        console.log('=== PROMO CONFIGURATION ===');
        console.log('Total codes configured:', Object.keys(PROMO_CONFIG).length);
        Object.entries(PROMO_CONFIG).forEach(([code, config]) => {
          console.log(`Code: ${code}`);
          console.log(`  Products: ${config.products.join(', ') || 'None'}`);
        });
        console.log('===========================');
      };
      
      console.log('Promo section loaded. Type checkPromoConfig() to see configuration.');
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Apply your promo code"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Enter a promo code to get a discount"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input placeholder",
      "default": "Enter promo code"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Apply"
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Background Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section Height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "vh"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button background",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Discount Codes"
    },
    {
      "type": "paragraph",
      "content": "Configure up to 8 discount codes. Enter the code exactly as created in Shopify admin, and optionally specify product handles (comma-separated) to auto-add to cart."
    },
    {
      "type": "text",
      "id": "fallback_code_1",
      "label": "Discount Code 1"
    },
    {
      "type": "text",
      "id": "fallback_products_1",
      "label": "Product Handles for Code 1",
      "info": "Comma-separated (e.g., product-1,product-2). Leave blank to only apply discount."
    },
    {
      "type": "text",
      "id": "fallback_code_2",
      "label": "Discount Code 2"
    },
    {
      "type": "text",
      "id": "fallback_products_2",
      "label": "Product Handles for Code 2"
    },
    {
      "type": "text",
      "id": "fallback_code_3",
      "label": "Discount Code 3"
    },
    {
      "type": "text",
      "id": "fallback_products_3",
      "label": "Product Handles for Code 3"
    },
    {
      "type": "text",
      "id": "fallback_code_4",
      "label": "Discount Code 4"
    },
    {
      "type": "text",
      "id": "fallback_products_4",
      "label": "Product Handles for Code 4"
    },
    {
      "type": "text",
      "id": "fallback_code_5",
      "label": "Discount Code 5"
    },
    {
      "type": "text",
      "id": "fallback_products_5",
      "label": "Product Handles for Code 5"
    },
    {
      "type": "text",
      "id": "fallback_code_6",
      "label": "Discount Code 6"
    },
    {
      "type": "text",
      "id": "fallback_products_6",
      "label": "Product Handles for Code 6"
    },
    {
      "type": "text",
      "id": "fallback_code_7",
      "label": "Discount Code 7"
    },
    {
      "type": "text",
      "id": "fallback_products_7",
      "label": "Product Handles for Code 7"
    },
    {
      "type": "text",
      "id": "fallback_code_8",
      "label": "Discount Code 8"
    },
    {
      "type": "text",
      "id": "fallback_products_8",
      "label": "Product Handles for Code 8"
    }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}