<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      <button id="applyPromoBtn" type="button" class="apply-promo-btn">
        {{ section.settings.button_text }}
      </button>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
      /* basic styling - adjust values as you like */
      #apply-promo-section.apply-promo-section { padding: 30px 20px 100px 20px; text-align:center; background: {{ section.settings.bg_color }}; }
      .apply-promo-inner { max-width: 900px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; align-items:center; }
      .apply-promo-title { margin:0;  font-size: clamp(28px, 4vw, 48px); color:{{ section.settings.title_color }}; }
      .apply-promo-subtitle { margin:0; font-size:18px; color:{{ section.settings.subtitle_color }}; }
      .apply-promo-form {position:relative; display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap; }
      .apply-promo-input { padding:10px 14px; min-width:220px; max-width:420px; border:1px solid #ccc; border-radius:4px; }
      .apply-promo-btn { text-transform:uppercase; padding:10px 16px; border:none; cursor:pointer; border-radius:4px; background:{{ section.settings.button_bg }}; color:{{ section.settings.button_color }}; }
      .apply-promo-msg { position: absolute;
    bottom: -23px;margin-top:8px; font-size:13px; color:#e74c3c; min-height:18px; }
      .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
      @media (min-width: 700px) {
        .apply-promo-form { flex-wrap:nowrap; }
      }
  </style>

  <script>
    (function () {
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const msg = document.getElementById('applyPromoMsg');

      function setMessage(text, isError) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#e74c3c' : '#2ecc71';
      }

      btn.addEventListener('click', function () {
        const code = input.value.trim();
        if (!code) {
          setMessage('Please enter a promo code.', true);
          input.focus();
          return;
        }

        // Dynamic product code mapping from theme settings
        const productCodes = {
          {%- if section.settings.code_1 != blank and section.settings.product_handle_1 != blank -%}
          '{{ section.settings.code_1 }}': {
            title: '{{ section.settings.product_title_1 | default: "Product 1" }}',
            handle: '{{ section.settings.product_handle_1 }}',
            quantity: {{ section.settings.quantity_1 | default: 1 }}
          }{%- if section.settings.code_2 != blank and section.settings.product_handle_2 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_2 != blank and section.settings.product_handle_2 != blank -%}
          '{{ section.settings.code_2 }}': {
            title: '{{ section.settings.product_title_2 | default: "Product 2" }}',
            handle: '{{ section.settings.product_handle_2 }}',
            quantity: {{ section.settings.quantity_2 | default: 1 }}
          }{%- if section.settings.code_3 != blank and section.settings.product_handle_3 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_3 != blank and section.settings.product_handle_3 != blank -%}
          '{{ section.settings.code_3 }}': {
            title: '{{ section.settings.product_title_3 | default: "Product 3" }}',
            handle: '{{ section.settings.product_handle_3 }}',
            quantity: {{ section.settings.quantity_3 | default: 1 }}
          }{%- if section.settings.code_4 != blank and section.settings.product_handle_4 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_4 != blank and section.settings.product_handle_4 != blank -%}
          '{{ section.settings.code_4 }}': {
            title: '{{ section.settings.product_title_4 | default: "Product 4" }}',
            handle: '{{ section.settings.product_handle_4 }}',
            quantity: {{ section.settings.quantity_4 | default: 1 }}
          }{%- if section.settings.code_5 != blank and section.settings.product_handle_5 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_5 != blank and section.settings.product_handle_5 != blank -%}
          '{{ section.settings.code_5 }}': {
            title: '{{ section.settings.product_title_5 | default: "Product 5" }}',
            handle: '{{ section.settings.product_handle_5 }}',
            quantity: {{ section.settings.quantity_5 | default: 1 }}
          }{%- if section.settings.code_6 != blank and section.settings.product_handle_6 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_6 != blank and section.settings.product_handle_6 != blank -%}
          '{{ section.settings.code_6 }}': {
            title: '{{ section.settings.product_title_6 | default: "Product 6" }}',
            handle: '{{ section.settings.product_handle_6 }}',
            quantity: {{ section.settings.quantity_6 | default: 1 }}
          }{%- if section.settings.code_7 != blank and section.settings.product_handle_7 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_7 != blank and section.settings.product_handle_7 != blank -%}
          '{{ section.settings.code_7 }}': {
            title: '{{ section.settings.product_title_7 | default: "Product 7" }}',
            handle: '{{ section.settings.product_handle_7 }}',
            quantity: {{ section.settings.quantity_7 | default: 1 }}
          }{%- if section.settings.code_8 != blank and section.settings.product_handle_8 != blank -%},{%- endif -%}
          {%- endif -%}
          {%- if section.settings.code_8 != blank and section.settings.product_handle_8 != blank -%}
          '{{ section.settings.code_8 }}': {
            title: '{{ section.settings.product_title_8 | default: "Product 8" }}',
            handle: '{{ section.settings.product_handle_8 }}',
            quantity: {{ section.settings.quantity_8 | default: 1 }}
          }
          {%- endif -%}
        };

        // Check if code matches a product
        const productData = productCodes[code];
        if (!productData) {
          setMessage('Invalid promo code. Please try again.', true);
          return;
        }

        setMessage('Adding product to cart...', false);
        btn.disabled = true;

        // First, get the product data to find variant ID
        fetch(`/products/${productData.handle}.js`)
          .then((response) => response.json())
          .then((product) => {
            if (!product || !product.variants || product.variants.length === 0) {
              throw new Error('Product not found or no variants available');
            }

            // Get the first available variant
            const variant = product.variants.find((v) => v.available) || product.variants[0];

            // Add to cart
            return fetch('/cart/add.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                id: variant.id,
                quantity: productData.quantity,
              }),
            });
          })
          .then((response) => response.json())
          .then((item) => {
            setMessage('Product added successfully! Redirecting to checkout...', false);
            // Redirect to checkout after successful add
            setTimeout(function () {
              window.location.href = '/checkout';
            }, 500);
          })
          .catch((error) => {
            console.error('Error:', error);
            setMessage('Error adding product to cart. Please try again.', true);
            btn.disabled = false;
          });
      });

      // Allow Enter key
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          btn.click();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    { "type": "header", "content": "Section Settings" },
    { "type": "text", "id": "title", "label": "Title", "default": "Apply your promo code" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Enter a promo code to get a discount" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Enter promo code" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Apply" },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "title_color", "label": "Title color", "default": "#111111" },
    { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#666666" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_color", "label": "Button text color", "default": "#ffffff" },
    
    { "type": "header", "content": "Promo Code 1" },
    { "type": "text", "id": "code_1", "label": "Promo Code 1", "info": "Enter the promo code (e.g., EWC25-TEE-15-EYT19SL4)" },
    { "type": "text", "id": "product_handle_1", "label": "Product Handle for Code 1", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_1", "label": "Product Title 1", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_1", "label": "Quantity 1", "default": 1 },
    
    { "type": "header", "content": "Promo Code 2" },
    { "type": "text", "id": "code_2", "label": "Promo Code 2" },
    { "type": "text", "id": "product_handle_2", "label": "Product Handle for Code 2", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_2", "label": "Product Title 2", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_2", "label": "Quantity 2", "default": 1 },
    
    { "type": "header", "content": "Promo Code 3" },
    { "type": "text", "id": "code_3", "label": "Promo Code 3" },
    { "type": "text", "id": "product_handle_3", "label": "Product Handle for Code 3", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_3", "label": "Product Title 3", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_3", "label": "Quantity 3", "default": 1 },
    
    { "type": "header", "content": "Promo Code 4" },
    { "type": "text", "id": "code_4", "label": "Promo Code 4" },
    { "type": "text", "id": "product_handle_4", "label": "Product Handle for Code 4", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_4", "label": "Product Title 4", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_4", "label": "Quantity 4", "default": 1 },
    
    { "type": "header", "content": "Promo Code 5" },
    { "type": "text", "id": "code_5", "label": "Promo Code 5" },
    { "type": "text", "id": "product_handle_5", "label": "Product Handle for Code 5", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_5", "label": "Product Title 5", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_5", "label": "Quantity 5", "default": 1 },
    
    { "type": "header", "content": "Promo Code 6" },
    { "type": "text", "id": "code_6", "label": "Promo Code 6" },
    { "type": "text", "id": "product_handle_6", "label": "Product Handle for Code 6", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_6", "label": "Product Title 6", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_6", "label": "Quantity 6", "default": 1 },
    
    { "type": "header", "content": "Promo Code 7" },
    { "type": "text", "id": "code_7", "label": "Promo Code 7" },
    { "type": "text", "id": "product_handle_7", "label": "Product Handle for Code 7", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_7", "label": "Product Title 7", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_7", "label": "Quantity 7", "default": 1 },
    
    { "type": "header", "content": "Promo Code 8" },
    { "type": "text", "id": "code_8", "label": "Promo Code 8" },
    { "type": "text", "id": "product_handle_8", "label": "Product Handle for Code 8", "info": "Enter the product handle (found in product URL). Use unlisted/hidden products only." },
    { "type": "text", "id": "product_title_8", "label": "Product Title 8", "info": "Enter the product title for display" },
    { "type": "number", "id": "quantity_8", "label": "Quantity 8", "default": 1 }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}
