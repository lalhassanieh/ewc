<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      {% comment %}
        <div class="wpbingo-button">
          <button id="applyPromoBtn" type="button" class="bwp-button default apply-promo-btn" tabindex="0">
            <span class="bwp-button-content-wrapper">
              <span class="bwp-button-text">{{ section.settings.button_text }}</span>
            </span>
          </button>
        </div>
      {% endcomment %}
      <div class="wpbingo-button">
        <div id="applyPromoBtn" class="bwp-button default apply-promo-btn">
          <span class="bwp-button-content-wrapper">
            <span class="bwp-button-text">{{ section.settings.button_text }}</span>
          </span>
        </div>
      </div>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
          /* basic styling - adjust values as you like */
          #apply-promo-section.apply-promo-section {
            {% comment %} padding: 30px 20px 100px 20px; {% endcomment %}
             height: {{ section.settings.section_height | default: 90 }}vh;
            text-align:center;
            background: {{ section.settings.bg_color }};
            {% if section.settings.bg_image != blank %}
            background-image: url('{{ section.settings.bg_image | image_url: width: 1920 }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            {% endif %}
            position: relative;
          }
          {% if section.settings.bg_image != blank and section.settings.bg_overlay_opacity > 0 %}
          #apply-promo-section.apply-promo-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }});
            z-index: 1;
          }
          {% endif %}
         .apply-promo-inner {
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      z-index: 2;
      top: 50%;
      position: absolute;
      transform: translate(-50%,-50%);
      left: 50%;
    }
          .apply-promo-title { margin:0;  font-size: clamp(28px, 4vw, 35px); color:{{ section.settings.title_color }}; }
          .apply-promo-subtitle {padding-bottom: 10px; margin:0; font-size:18px; color:{{ section.settings.subtitle_color }}; }
          .apply-promo-form {position:relative; display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap; }
          .apply-promo-input { padding:10px 14px; min-width:220px; max-width:420px; border:1px solid #ccc; border-radius:4px; }
          .apply-promo-btn.bwp-button { text-transform:uppercase; padding:10px 16px; border:none; cursor:pointer; border-radius:4px; background:{{ section.settings.button_bg }}; color:{{ section.settings.button_color }}; }
          .apply-promo-btn .bwp-button-text { color: {{ section.settings.button_color }}; }
          .apply-promo-msg { position: absolute;
        bottom: -23px;margin-top:8px; font-size:13px; color:#e74c3c; min-height:18px; }
          .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
          @media (min-width: 700px) {
            .apply-promo-form { flex-wrap:nowrap; }
          }
  </style>

  <script>
    (function () {
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const msg = document.getElementById('applyPromoMsg');

      function setMessage(text, isError) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#e74c3c' : '#2ecc71';
      }

      btn.addEventListener('click', function () {
        const code = input.value.trim();
        if (!code) {
          setMessage('Please enter a promo code.', true);
          input.focus();
          return;
        }

        setMessage('Checking discount code...', false);
        btn.disabled = true;

        // Step 1: Check if the code exists in backend configuration and get products
        checkCodeInBackend(code)
        .then((configResult) => {
          if (!configResult.found) {
            const error = new Error('Invalid Discount code.');
            error.step = 'Backend Configuration Check';
            throw error;
          }

          setMessage('Code found in system! Validating with Shopify...', false);
          
          // Step 2: Validate the discount code with Shopify backend, passing the configured products
          return validateDiscountCode(code, configResult.products);
        })
        .then((discountData) => {
          if (!discountData.valid) {
            const error = new Error(discountData.message || 'This discount code is invalid or has expired');
            error.step = 'Shopify Validation';
            throw error;
          }
          
          if (discountData.used) {
            const error = new Error('This discount code has already been used and cannot be used again');
            error.step = 'Usage Check';
            throw error;
          }

          setMessage('Discount code validated! Getting assigned products from Shopify...', false);
          
          // Step 3: Get products assigned to this discount from Shopify
          return getDiscountProducts(discountData);
        })
        .then((products) => {
          if (!products || products.length === 0) {
            const error = new Error('No products assigned to this discount code');
            error.step = 'Product Assignment';
            throw error;
          }

          setMessage('Clearing cart and adding products...', false);

          // Step 4: Clear cart first
          return fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(() => products);
        })
        .then((products) => {
          // Step 5: Add all assigned products to cart
          return addProductsToCart(products);
        })
        .then(() => {
          // Step 6: Apply discount code and redirect to checkout
          setMessage('Products added! Applying discount and redirecting...', false);
          
          // Apply the discount code to the cart
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: {
                'discount_code': code
              }
            })
          });
        })
        .then(() => {
          // Redirect to checkout with discount code
          setTimeout(() => {
            window.location.href = `/checkout?discount=${encodeURIComponent(code)}`;
          }, 500);
        })
        .catch((error) => {
          console.error('Discount code processing error:', error);
          
          // Show specific error message to user with step info
          let errorMessage = error.message || 'An unexpected error occurred. Please try again.';
          
          // Add step information for debugging
          if (error.step) {
            errorMessage += ` (Step: ${error.step})`;
          }
          
          setMessage(errorMessage, true);
          btn.disabled = false;
        });

      // Function to check if code exists in backend configuration and get its products
      function checkCodeInBackend(code) {
        return new Promise((resolve) => {
          // Get all configured discount codes and their products from section settings
          const discountConfigs = [];
          
          {%- assign code1 = section.settings.discount_code_1 | strip -%}
          {%- assign code2 = section.settings.discount_code_2 | strip -%}
          {%- assign code3 = section.settings.discount_code_3 | strip -%}
          
          // Build discount configuration array
          {%- if code1 != blank and code1 != '' -%}
          const config1 = {
            code: '{{ code1 | escape }}',
            products: []
          };
          {%- assign handle1_1 = section.settings.product_handle_1_1 | strip -%}
          {%- assign handle1_2 = section.settings.product_handle_1_2 | strip -%}
          {%- assign handle1_3 = section.settings.product_handle_1_3 | strip -%}
          {%- if handle1_1 != blank and handle1_1 != '' -%}
          config1.products.push({ handle: '{{ handle1_1 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle1_2 != blank and handle1_2 != '' -%}
          config1.products.push({ handle: '{{ handle1_2 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle1_3 != blank and handle1_3 != '' -%}
          config1.products.push({ handle: '{{ handle1_3 | escape }}', quantity: 1 });
          {%- endif -%}
          discountConfigs.push(config1);
          {%- endif -%}

          {%- if code2 != blank and code2 != '' -%}
          const config2 = {
            code: '{{ code2 | escape }}',
            products: []
          };
          {%- assign handle2_1 = section.settings.product_handle_2_1 | strip -%}
          {%- assign handle2_2 = section.settings.product_handle_2_2 | strip -%}
          {%- assign handle2_3 = section.settings.product_handle_2_3 | strip -%}
          {%- if handle2_1 != blank and handle2_1 != '' -%}
          config2.products.push({ handle: '{{ handle2_1 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle2_2 != blank and handle2_2 != '' -%}
          config2.products.push({ handle: '{{ handle2_2 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle2_3 != blank and handle2_3 != '' -%}
          config2.products.push({ handle: '{{ handle2_3 | escape }}', quantity: 1 });
          {%- endif -%}
          discountConfigs.push(config2);
          {%- endif -%}

          {%- if code3 != blank and code3 != '' -%}
          const config3 = {
            code: '{{ code3 | escape }}',
            products: []
          };
          {%- assign handle3_1 = section.settings.product_handle_3_1 | strip -%}
          {%- assign handle3_2 = section.settings.product_handle_3_2 | strip -%}
          {%- assign handle3_3 = section.settings.product_handle_3_3 | strip -%}
          {%- if handle3_1 != blank and handle3_1 != '' -%}
          config3.products.push({ handle: '{{ handle3_1 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle3_2 != blank and handle3_2 != '' -%}
          config3.products.push({ handle: '{{ handle3_2 | escape }}', quantity: 1 });
          {%- endif -%}
          {%- if handle3_3 != blank and handle3_3 != '' -%}
          config3.products.push({ handle: '{{ handle3_3 | escape }}', quantity: 1 });
          {%- endif -%}
          discountConfigs.push(config3);
          {%- endif -%}
          
          console.log('DEBUG: Discount configurations:', discountConfigs);

          // Find matching discount configuration (case-insensitive)
          const codeToCheck = code.trim().toLowerCase();
          const matchedConfig = discountConfigs.find(config => 
            config.code.trim().toLowerCase() === codeToCheck && 
            config.products.length > 0
          );
          
          if (matchedConfig) {
            console.log('DEBUG: Found matching configuration:', matchedConfig);
            resolve({
              found: true,
              products: matchedConfig.products
            });
          } else {
            console.log('DEBUG: No matching configuration found for code:', code);
            resolve({
              found: false,
              products: []
            });
          }
        });
      }

      // Function to validate discount code with Shopify
      async function validateDiscountCode(code, configuredProducts) {
        try {
          console.log('DEBUG: Starting Shopify validation for:', code);
          console.log('DEBUG: Using configured products:', configuredProducts);
          
          // Try to validate the discount by testing with one of the configured products
          const firstProduct = configuredProducts[0];
          
          // Get the product details to test with
          const productResponse = await fetch(`/products/${firstProduct.handle}.js`);
          if (!productResponse.ok) {
            throw new Error(`Product ${firstProduct.handle} not found`);
          }
          
          const testProduct = await productResponse.json();
          const testVariant = testProduct.variants[0];
          
          console.log('DEBUG: Using configured product for validation:', testProduct.handle);
          
          // Add test product to cart
          const addResponse = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: testVariant.id,
              quantity: 1
            })
          });
          
          if (!addResponse.ok) {
            throw new Error('Failed to add test product to cart');
          }
          
          console.log('DEBUG: Test product added to cart');
          
          // Try to apply discount code to the cart to see if it's valid
          const updateResponse = await fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: {
                'discount_code': code
              }
            })
          });
          
          console.log('DEBUG: Cart update with discount response status:', updateResponse.status);
          
          if (updateResponse.ok) {
            // Discount code was accepted, use the configured products
            
            // Clean up - remove test product from cart
            await fetch('/cart/clear.js', { method: 'POST' });
            
            return {
              valid: true,
              used: false,
              code: code,
              type: 'configured',
              value: null,
              applicableProducts: configuredProducts
            };
          }
          
          if (discountResponse.status === 404) {
            // Clean up
            await fetch('/cart/clear.js', { method: 'POST' });
            return { valid: false, message: 'Discount code does not exist in Shopify' };
          }
          
          // Clean up and assume valid if inconclusive
          await fetch('/cart/clear.js', { method: 'POST' });
          
          return {
            valid: true,
            used: false,
            code: code,
            type: 'assumed',
            value: null,
            applicableProducts: []
          };
          
        } catch (error) {
          console.error('DEBUG: Shopify validation error:', error);
          
          // Clean up cart in case of error
          try {
            await fetch('/cart/clear.js', { method: 'POST' });
          } catch (cleanupError) {
            console.error('Cart cleanup failed:', cleanupError);
          }
          
          // Return assumed valid to avoid blocking legitimate discounts
          return {
            valid: true,
            used: false,
            code: code,
            type: 'error',
            value: null,
            applicableProducts: []
          };
        }
      }
      
      // Function to detect which products a discount applies to
      async function detectDiscountProducts(code) {
        try {
          console.log('DEBUG: Attempting to detect products for discount:', code);
          
          // Strategy: Test products from catalog to see which ones work with the discount
          console.log('DEBUG: Testing products for discount compatibility');
          
          // Get all products to find potential matches
          const productsResponse = await fetch('/products.json?limit=250');
          const productsData = await productsResponse.json();
          
          if (!productsData.products || productsData.products.length === 0) {
            console.log('DEBUG: No products available for testing');
            return [];
          }
          
          // Strategy 1: Look for products that might be free gifts based on name/title
          const giftKeywords = ['gift', 'free', 'hat', 'worlds2025', 'ewc'];
          const potentialGifts = productsData.products.filter(product => {
            const title = product.title.toLowerCase();
            return giftKeywords.some(keyword => title.includes(keyword));
          });
          
          console.log('DEBUG: Found potential gift products:', potentialGifts.map(p => p.title));
          
          // Test potential gift products first
          const applicableProducts = [];
          
          for (const product of potentialGifts) {
            try {
              const isApplicable = await testProductWithDiscount(product, code);
              if (isApplicable) {
                console.log('DEBUG: Gift product applies to discount:', product.handle);
                applicableProducts.push({ handle: product.handle, quantity: 1 });
              }
            } catch (testError) {
              console.log('DEBUG: Error testing gift product:', product.handle, testError);
            }
          }
          
          // If no gift products found, test a sample of regular products
          if (applicableProducts.length === 0) {
            console.log('DEBUG: No gift products worked, testing regular products');
            for (const product of productsData.products.slice(0, 10)) {
              try {
                const isApplicable = await testProductWithDiscount(product, code);
                if (isApplicable) {
                  console.log('DEBUG: Regular product applies to discount:', product.handle);
                  applicableProducts.push({ handle: product.handle, quantity: 1 });
                }
              } catch (testError) {
                console.log('DEBUG: Error testing regular product:', product.handle, testError);
              }
            }
          }
          
          if (applicableProducts.length > 0) {
            console.log('DEBUG: Found applicable products through testing:', applicableProducts);
            return applicableProducts.slice(0, 3); // Limit to 3 products max
          }
          
          console.log('DEBUG: No applicable products found through testing');
          return [];
          
        } catch (error) {
          console.error('DEBUG: Error detecting discount products:', error);
          return [];
        }
      }
      
      // Test if a specific product works with the discount
      async function testProductWithDiscount(product, discountCode) {
        try {
          if (!product.variants || product.variants.length === 0) {
            return false;
          }
          
          const variant = product.variants[0];
          
          // Clear cart first
          await fetch('/cart/clear.js', { method: 'POST' });
          
          // Add the product to cart
          const addResponse = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: variant.id,
              quantity: 1
            })
          });
          
          if (!addResponse.ok) {
            return false;
          }
          
          // Get cart before discount
          const cartBeforeResponse = await fetch('/cart.js');
          const cartBefore = await cartBeforeResponse.json();
          const priceBefore = cartBefore.total_price;
          
          // Try to update cart with discount code
          const discountUpdateResponse = await fetch('/cart/update.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              attributes: {
                'discount_code': discountCode
              }
            })
          });
          
          if (discountUpdateResponse.ok) {
            // Get cart after discount attempt
            const cartAfterResponse = await fetch('/cart.js');
            const cartAfter = await cartAfterResponse.json();
            const priceAfter = cartAfter.total_price;
            
            // Check if price changed or if it's a 100% discount (free product)
            if (priceAfter < priceBefore || (priceBefore > 0 && priceAfter === 0)) {
              console.log('DEBUG: Discount applied! Price changed from', priceBefore, 'to', priceAfter);
              return true;
            }
            
            // For 100% off discounts on free products, check if discount code appears in cart attributes
            if (cartAfter.attributes && cartAfter.attributes.discount_code === discountCode) {
              console.log('DEBUG: Discount code accepted in cart attributes');
              return true;
            }
          }
          
          return false;
          
        } catch (error) {
          console.error('Error testing product with discount:', error);
          return false;
        }
      }

      // Function to extract discount type from Shopify response
      function extractDiscountType(html) {
        // Look for discount type indicators in the HTML
        if (html.includes('percentage') || html.includes('%')) return 'percentage';
        if (html.includes('fixed_amount') || html.includes('$')) return 'fixed_amount';
        return 'unknown';
      }

      // Function to extract discount value from Shopify response
      function extractDiscountValue(html) {
        // Extract discount value from HTML response
        const percentageMatch = html.match(/(\d+)%/);
        if (percentageMatch) return percentageMatch[1];
        
        const amountMatch = html.match(/\$(\d+(?:\.\d{2})?)/);
        if (amountMatch) return amountMatch[1];
        
        return null;
      }

      // Function to extract applicable products from Shopify checkout response
      function extractApplicableProducts(html) {
        try {
          // Try to find product handles in the checkout response
          const productMatches = html.match(/\/products\/([a-zA-Z0-9\-_]+)/g);
          if (productMatches && productMatches.length > 0) {
            const uniqueHandles = [...new Set(productMatches.map(match => 
              match.replace('/products/', '')
            ))];
            return uniqueHandles.map(handle => ({ handle, quantity: 1 }));
          }
          
          // Alternative: look for data-product-handle attributes
          const handleMatches = html.match(/data-product-handle=['"]([^'"]+)['"]/g);
          if (handleMatches && handleMatches.length > 0) {
            const handles = handleMatches.map(match => 
              match.match(/data-product-handle=['"]([^'"]+)['"]/)[1]
            );
            return [...new Set(handles)].map(handle => ({ handle, quantity: 1 }));
          }
          
          return [];
        } catch (error) {
          return [];
        }
      }

      // Function to get products assigned to this discount
      async function getDiscountProducts(discountData) {
        try {
          console.log('DEBUG: Getting products for discount:', discountData.code);
          console.log('DEBUG: Discount data:', discountData);
          
          // Use the configured products from backend configuration
          if (discountData.type === 'configured' && discountData.applicableProducts && discountData.applicableProducts.length > 0) {
            console.log('DEBUG: Using configured products:', discountData.applicableProducts);
            return discountData.applicableProducts;
          }
          
          // If no products configured or validation failed, throw error
          const error = new Error('No products configured for this discount code. Please contact support.');
          error.step = 'Product Assignment';
          throw error;
          
        } catch (error) {
          console.error('Error getting discount products:', error);
          if (!error.step) error.step = 'Product Assignment';
          throw error;
        }
      }
      



      // Function to add multiple products to cart
      async function addProductsToCart(products) {
        const addPromises = products.map(async (productData) => {
          // Get product details
          const response = await fetch(`/products/${productData.handle}.js`);
          const product = await response.json();
          
          if (!product || !product.variants || product.variants.length === 0) {
            throw new Error(`Product ${productData.handle} not found or no variants available`);
          }

          // Get the first available variant
          const variant = product.variants.find((v) => v.available) || product.variants[0];

          // Add to cart
          return fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variant.id,
              quantity: productData.quantity,
            }),
          });
        });

        return Promise.all(addPromises);
      }
      });

      // Allow Enter key
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          btn.click();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    { "type": "header", "content": "Section Settings" },
    { "type": "text", "id": "title", "label": "Title", "default": "Apply your promo code" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Enter a promo code to get a discount" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Enter promo code" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Apply" },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image",
      "info": "Optional background image for the entire section"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Background Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "info": "Add a dark overlay over the background image to improve text readability"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section Height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "vh",
      "info": "Set the height of the section as a percentage of viewport height"
    },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "title_color", "label": "Title color", "default": "#111111" },
    { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#666666" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_color", "label": "Button text color", "default": "#ffffff" },

    { "type": "header", "content": "Backend Discount Code Configuration" },
    { 
      "type": "paragraph", 
      "content": "IMPORTANT: Only discount codes entered in this section will be accepted by the form. System checks backend configuration first, then validates with Shopify, then automatically gets assigned products from Shopify discount settings." 
    },

    { "type": "header", "content": "Discount Configuration" },
    { 
      "type": "paragraph", 
      "content": "Configure discount codes and their associated products. Each discount code must have at least one product handle specified." 
    },

    { "type": "header", "content": "Discount Code 1" },
    {
      "type": "text",
      "id": "discount_code_1",
      "label": "Discount Code",
      "info": "Enter the exact discount code (must exist in Shopify admin)"
    },
    {
      "type": "text",
      "id": "product_handle_1_1",
      "label": "Product Handle 1",
      "info": "Product handle (from product URL) to add when this discount is applied"
    },
    {
      "type": "text",
      "id": "product_handle_1_2",
      "label": "Product Handle 2 (Optional)",
      "info": "Optional second product handle"
    },
    {
      "type": "text",
      "id": "product_handle_1_3",
      "label": "Product Handle 3 (Optional)",
      "info": "Optional third product handle"
    },

    { "type": "header", "content": "Discount Code 2" },
    {
      "type": "text",
      "id": "discount_code_2",
      "label": "Discount Code",
      "info": "Enter the exact discount code (must exist in Shopify admin)"
    },
    {
      "type": "text",
      "id": "product_handle_2_1",
      "label": "Product Handle 1",
      "info": "Product handle (from product URL) to add when this discount is applied"
    },
    {
      "type": "text",
      "id": "product_handle_2_2",
      "label": "Product Handle 2 (Optional)",
      "info": "Optional second product handle"
    },
    {
      "type": "text",
      "id": "product_handle_2_3",
      "label": "Product Handle 3 (Optional)",
      "info": "Optional third product handle"
    },

    { "type": "header", "content": "Discount Code 3" },
    {
      "type": "text",
      "id": "discount_code_3",
      "label": "Discount Code",
      "info": "Enter the exact discount code (must exist in Shopify admin)"
    },
    {
      "type": "text",
      "id": "product_handle_3_1",
      "label": "Product Handle 1",
      "info": "Product handle (from product URL) to add when this discount is applied"
    },
    {
      "type": "text",
      "id": "product_handle_3_2",
      "label": "Product Handle 2 (Optional)",
      "info": "Optional second product handle"
    },
    {
      "type": "text",
      "id": "product_handle_3_3",
      "label": "Product Handle 3 (Optional)",
      "info": "Optional third product handle"
    }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}
