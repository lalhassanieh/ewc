<!-- sections/apply-promo.liquid -->
<section id="apply-promo-section" class="apply-promo-section">
  <div class="apply-promo-inner">
    <h2 class="apply-promo-title">{{ section.settings.title }}</h2>
    <p class="apply-promo-subtitle">{{ section.settings.subtitle }}</p>

    <form id="applyPromoForm" class="apply-promo-form" onsubmit="return false;">
      <label for="applyPromoCode" class="visually-hidden">Promo code</label>
      <input
        id="applyPromoCode"
        name="code"
        type="text"
        placeholder="{{ section.settings.placeholder }}"
        aria-label="Promo code"
        class="apply-promo-input"
      >

      {% comment %}
        <div class="wpbingo-button">
          <button id="applyPromoBtn" type="button" class="bwp-button default apply-promo-btn" tabindex="0">
            <span class="bwp-button-content-wrapper">
              <span class="bwp-button-text">{{ section.settings.button_text }}</span>
            </span>
          </button>
        </div>
      {% endcomment %}
      <div class="wpbingo-button">
        <div id="applyPromoBtn" class="bwp-button default apply-promo-btn">
          <span class="bwp-button-content-wrapper">
            <span class="bwp-button-text">{{ section.settings.button_text }}</span>
          </span>
        </div>
      </div>
      <div id="applyPromoMsg" class="apply-promo-msg" aria-live="polite"></div>
    </form>
  </div>

  <style>
          /* basic styling - adjust values as you like */
          #apply-promo-section.apply-promo-section {
            {% comment %} padding: 30px 20px 100px 20px; {% endcomment %}
             height: {{ section.settings.section_height | default: 90 }}vh;
            text-align:center;
            background: {{ section.settings.bg_color }};
            {% if section.settings.bg_image != blank %}
            background-image: url('{{ section.settings.bg_image | image_url: width: 1920 }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            {% endif %}
            position: relative;
          }
          {% if section.settings.bg_image != blank and section.settings.bg_overlay_opacity > 0 %}
          #apply-promo-section.apply-promo-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }});
            z-index: 1;
          }
          {% endif %}
         .apply-promo-inner {
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      z-index: 2;
      top: 50%;
      position: absolute;
      transform: translate(-50%,-50%);
      left: 50%;
    }
          .apply-promo-title { margin:0;  font-size: clamp(28px, 4vw, 35px); color:{{ section.settings.title_color }}; }
          .apply-promo-subtitle {padding-bottom: 10px; margin:0; font-size:18px; color:{{ section.settings.subtitle_color }}; }
          .apply-promo-form {position:relative; display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap; }
          .apply-promo-input { padding:10px 14px; min-width:220px; max-width:420px; border:1px solid #ccc; border-radius:4px; }
          .apply-promo-btn.bwp-button { text-transform:uppercase; padding:10px 16px; border:none; cursor:pointer; border-radius:4px; background:{{ section.settings.button_bg }}; color:{{ section.settings.button_color }}; }
          .apply-promo-btn .bwp-button-text { color: {{ section.settings.button_color }}; }
          .apply-promo-msg { position: absolute;
        bottom: -23px;margin-top:8px; font-size:13px; color:#e74c3c; min-height:18px; }
          .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
          @media (min-width: 700px) {
            .apply-promo-form { flex-wrap:nowrap; }
          }
  </style>

  <script>
    (function () {
      const form = document.getElementById('applyPromoForm');
      const input = document.getElementById('applyPromoCode');
      const btn = document.getElementById('applyPromoBtn');
      const msg = document.getElementById('applyPromoMsg');

      function setMessage(text, isError) {
        msg.textContent = text || '';
        msg.style.color = isError ? '#e74c3c' : '#2ecc71';
      }

      btn.addEventListener('click', function () {
        const code = input.value.trim();
        if (!code) {
          setMessage('Please enter a promo code.', true);
          input.focus();
          return;
        }

        setMessage('Validating discount code...', false);
        btn.disabled = true;

        // Step 1: Validate the discount code with Shopify
        validateDiscountCode(code)
        .then((discountData) => {
          if (!discountData.valid) {
            throw new Error(discountData.message || 'Invalid discount code');
          }
          
          if (discountData.used) {
            throw new Error('This discount code has already been used');
          }

          setMessage('Discount code valid! Processing products...', false);
          
          // Step 2: Get products associated with this discount
          return getDiscountProducts(discountData);
        })
        .then((products) => {
          if (!products || products.length === 0) {
            throw new Error('No products found for this discount code');
          }

          setMessage('Clearing cart and adding products...', false);

          // Step 3: Clear cart
          return fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(() => products);
        })
        .then((products) => {
          // Step 4: Add all products to cart
          return addProductsToCart(products);
        })
        .then(() => {
          // Step 5: Apply discount code and redirect to checkout
          setMessage('Products added! Applying discount and redirecting...', false);
          
          // Apply the discount code to the cart
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: {
                'discount_code': code
              }
            })
          });
        })
        .then(() => {
          // Redirect to checkout with discount code
          setTimeout(() => {
            window.location.href = `/checkout?discount=${encodeURIComponent(code)}`;
          }, 500);
        })
        .catch((error) => {
          console.error('Error:', error);
          setMessage(error.message || 'Error processing request. Please try again.', true);
          btn.disabled = false;
        });

      // Function to validate discount code with Shopify
      async function validateDiscountCode(code) {
        try {
          // Create a temporary cart to test the discount
          const response = await fetch('/cart.js', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const cart = await response.json();
          
          // Try to apply discount to see if it exists and is valid
          const discountResponse = await fetch('/checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `discount=${encodeURIComponent(code)}&_method=GET`
          });

          if (discountResponse.ok) {
            // Check if discount was applied by examining response
            const text = await discountResponse.text();
            
            // Look for discount validation patterns in the HTML response
            if (text.includes('discount-code-error') || text.includes('discount_code_error')) {
              return { valid: false, message: 'Invalid or expired discount code' };
            }
            
            if (text.includes('discount-already-used') || text.includes('usage_limit_reached')) {
              return { valid: true, used: true, message: 'Discount code has already been used' };
            }

            // If we get here, discount is likely valid - extract product/collection info
            const discountInfo = extractDiscountInfo(text);
            return { 
              valid: true, 
              used: false, 
              code: code,
              type: discountInfo.type,
              value: discountInfo.value,
              productIds: discountInfo.productIds,
              collectionIds: discountInfo.collectionIds,
              isStoreWide: discountInfo.isStoreWide
            };
          } else {
            return { valid: false, message: 'Unable to validate discount code' };
          }
        } catch (error) {
          console.error('Discount validation error:', error);
          return { valid: false, message: 'Error validating discount code' };
        }
      }

      // Function to extract comprehensive discount info from Shopify response
      function extractDiscountInfo(html) {
        const discountInfo = {
          type: 'unknown',
          value: null,
          productIds: [],
          collectionIds: [],
          isStoreWide: false
        };

        // Extract discount type and value
        if (html.includes('percentage') || html.includes('%')) {
          discountInfo.type = 'percentage';
          const percentageMatch = html.match(/(\d+)%/);
          if (percentageMatch) discountInfo.value = percentageMatch[1];
        } else if (html.includes('fixed_amount') || html.includes('$')) {
          discountInfo.type = 'fixed_amount';
          const amountMatch = html.match(/\$(\d+(?:\.\d{2})?)/);
          if (amountMatch) discountInfo.value = amountMatch[1];
        }

        // Check if discount applies to specific products
        const productIdMatches = html.match(/product[_-]id["\']?\s*[:=]\s*["\']?(\d+)/gi);
        if (productIdMatches) {
          discountInfo.productIds = productIdMatches.map(match => {
            const id = match.match(/(\d+)/);
            return id ? id[1] : null;
          }).filter(Boolean);
        }

        // Check if discount applies to specific collections
        const collectionMatches = html.match(/collection[_-]id["\']?\s*[:=]\s*["\']?(\d+)/gi);
        if (collectionMatches) {
          discountInfo.collectionIds = collectionMatches.map(match => {
            const id = match.match(/(\d+)/);
            return id ? id[1] : null;
          }).filter(Boolean);
        }

        // Check if it's a store-wide discount (no product/collection restrictions)
        if (discountInfo.productIds.length === 0 && discountInfo.collectionIds.length === 0) {
          discountInfo.isStoreWide = true;
        }

        return discountInfo;
      }

      // Function to get products from the Shopify discount configuration
      async function getDiscountProducts(discountData) {
        try {
          // If discount has specific product restrictions, get them from Shopify
          if (discountData.productIds && discountData.productIds.length > 0) {
            // Get products specified in the discount
            const products = await Promise.all(
              discountData.productIds.map(async (productId) => {
                const response = await fetch(`/products/${productId}.js`);
                const product = await response.json();
                return {
                  handle: product.handle,
                  quantity: 1,
                  id: product.id,
                  title: product.title
                };
              })
            );
            return products;
          }

          // If discount applies to collections, get products from those collections
          if (discountData.collectionIds && discountData.collectionIds.length > 0) {
            const allProducts = [];
            for (const collectionId of discountData.collectionIds) {
              try {
                const response = await fetch(`/collections/${collectionId}/products.json?limit=250`);
                const data = await response.json();
                const products = data.products.map(product => ({
                  handle: product.handle,
                  quantity: 1,
                  id: product.id,
                  title: product.title
                }));
                allProducts.push(...products);
              } catch (error) {
                console.warn(`Failed to fetch collection ${collectionId}:`, error);
              }
            }
            
            if (allProducts.length > 0) {
              // Return first few products from the eligible collections
              return allProducts.slice(0, {{ section.settings.max_products | default: 5 }});
            }
          }

          // Fallback: Use default products from section settings if discount is store-wide
          const defaultProducts = [
            {%- if section.settings.default_product_1 != blank -%}
            { handle: '{{ section.settings.default_product_1 }}', quantity: {{ section.settings.default_quantity_1 | default: 1 }} },
            {%- endif -%}
            {%- if section.settings.default_product_2 != blank -%}
            { handle: '{{ section.settings.default_product_2 }}', quantity: {{ section.settings.default_quantity_2 | default: 1 }} },
            {%- endif -%}
            {%- if section.settings.default_product_3 != blank -%}
            { handle: '{{ section.settings.default_product_3 }}', quantity: {{ section.settings.default_quantity_3 | default: 1 }} }
            {%- endif -%}
          ].filter(p => p.handle);

          if (defaultProducts.length > 0) {
            return defaultProducts;
          }

          // If no products found, throw error
          throw new Error('No eligible products found for this discount code');

        } catch (error) {
          console.error('Error getting discount products:', error);
          throw new Error('Unable to determine products for this discount');
        }
      }

      // Function to add multiple products to cart
      async function addProductsToCart(products) {
        const addPromises = products.map(async (productData) => {
          // Get product details
          const response = await fetch(`/products/${productData.handle}.js`);
          const product = await response.json();
          
          if (!product || !product.variants || product.variants.length === 0) {
            throw new Error(`Product ${productData.handle} not found or no variants available`);
          }

          // Get the first available variant
          const variant = product.variants.find((v) => v.available) || product.variants[0];

          // Add to cart
          return fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variant.id,
              quantity: productData.quantity,
            }),
          });
        });

        return Promise.all(addPromises);
      }
      });

      // Allow Enter key
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          btn.click();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Apply promo code",
  "settings": [
    { "type": "header", "content": "Section Settings" },
    { "type": "text", "id": "title", "label": "Title", "default": "Apply your promo code" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Enter a promo code to get a discount" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Enter promo code" },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Apply" },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background Image",
      "info": "Optional background image for the entire section"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Background Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "info": "Add a dark overlay over the background image to improve text readability"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section Height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "vh",
      "info": "Set the height of the section as a percentage of viewport height"
    },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "title_color", "label": "Title color", "default": "#111111" },
    { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#666666" },
    { "type": "color", "id": "button_bg", "label": "Button background", "default": "#111111" },
    { "type": "color", "id": "button_color", "label": "Button text color", "default": "#ffffff" },

    { "type": "header", "content": "Automatic Discount Configuration" },
    { 
      "type": "paragraph", 
      "content": "The system automatically detects products from Shopify discount configurations. Products are fetched directly from the discount settings in Shopify Admin. Only configure fallback products for store-wide discounts." 
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Max Products to Add",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 5,
      "info": "Maximum number of products to add when discount applies to collections"
    },

    { "type": "header", "content": "Fallback Products (Store-wide Discounts)" },
    { 
      "type": "paragraph", 
      "content": "These products will be added to cart for store-wide discounts that don't specify particular products or collections." 
    },
    {
      "type": "text",
      "id": "default_product_1",
      "label": "Default Product 1 Handle",
      "info": "Product to add for store-wide discounts (optional)"
    },
    {
      "type": "number",
      "id": "default_quantity_1",
      "label": "Default Product 1 Quantity",
      "default": 1
    },
    {
      "type": "text",
      "id": "default_product_2",
      "label": "Default Product 2 Handle",
      "info": "Second product for store-wide discounts (optional)"
    },
    {
      "type": "number",
      "id": "default_quantity_2",
      "label": "Default Product 2 Quantity",
      "default": 1
    },
    {
      "type": "text",
      "id": "default_product_3",
      "label": "Default Product 3 Handle",
      "info": "Third product for store-wide discounts (optional)"
    },
    {
      "type": "number",
      "id": "default_quantity_3",
      "label": "Default Product 3 Quantity",
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Apply promo code",
      "category": "Promotions"
    }
  ]
}
{% endschema %}
